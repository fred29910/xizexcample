# Feature Specification: “斗牛牛”棋牌游戏服务器

**Feature Branch**: `001-`  
**Created**: 2025-10-10  
**Status**: Draft  
**Input**: User description: "构建一个功能完善、性能稳定的“斗牛牛”棋牌游戏服务器。该服务器需能够独立管理完整的游戏生命周期，处理客户端的实时通信请求，并精确执行游戏规则，所有游戏状态均在服务器内存中进行维护和管理。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 玩家加入并开始游戏 (Priority: P1)

玩家通过客户端请求加入一个游戏房间，当房间内玩家数达到开局要求后，游戏自动开始。

**Why this priority**: 这是游戏的核心入口，是所有后续玩法的基础。

**Independent Test**: 可以通过模拟多个客户端加入同一房间，并验证游戏是否在满足条件时正确开始。

**Acceptance Scenarios**:

1. **Given** 一个未满员的房间, **When** 一个玩家请求加入, **Then** 该玩家成功进入房间，并收到房间内其他玩家的信息。
2. **Given** 一个即将满员的房间, **When** 最后一个玩家请求加入, **Then** 游戏立即开始，所有玩家都收到游戏开始的通知和初始手牌。
3. **Given** 一个已满员的房间, **When** 一个玩家请求加入, **Then** 请求被拒绝，并收到“房间已满”的提示。

---

### User Story 2 - 完成一局完整的游戏流程 (Priority: P1)

从游戏开始到结束，玩家可以体验到叫庄、下注、比牌、结算等完整的“斗牛牛”核心玩法。

**Why this priority**: 构成了游戏的核心循环，是游戏可玩性的关键。

**Independent Test**: 在一个已开始的游戏中，模拟所有玩家依次进行叫庄、下注操作，并验证服务器能否正确比牌并根据结果进行结算。

**Acceptance Scenarios**:

1. **Given** 游戏已开始并发了手牌, **When** 所有玩家依次选择是否叫庄, **Then** 服务器能正确确定庄家。
2. **Given** 庄家已确定, **When** 所有闲家下注, **Then** 服务器记录每个闲家的下注额。
3. **Given** 所有玩家已亮牌, **When** 服务器进行比牌, **Then** 服务器能根据“斗牛牛”规则正确判断每个玩家的输赢。
4. **Given** 比牌已结束, **When** 服务器进行结算, **Then** 每个玩家的金币根据输赢和下注额正确变化。

---

### User Story 3 - 玩家断线重连 (Priority: P2)

玩家在游戏中意外断开连接后，可以在一定时间内重新连接回游戏，并恢复之前的游戏状态。

**Why this priority**: 提升用户体验，减少因网络问题导致的游戏中断和损失。

**Independent Test**: 在游戏中途断开一个模拟客户端的连接，然后在短时间内重新连接，验证其能否恢复游戏并继续操作。

**Acceptance Scenarios**:

1. **Given** 一个玩家在游戏中途断线, **When** 该玩家在指定时间内重连, **Then** 他能恢复到断线前的游戏界面，手牌和游戏状态保持不变。
2. **Given** 一个玩家在游戏中途断线, **When** 该玩家超过指定时间未重连, **Then** 系统自动替其托管或按离线处理。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 提供创建、加入和解散游戏房间的功能。
- **FR-002**: 系统 MUST 能够管理玩家的游戏状态（如：等待中、游戏中、离线）。
- **FR-003**: 系统 MUST 实现完整的“斗牛牛”游戏生命周期，包括准备、发牌、叫庄、下注、比牌和结算阶段。
- **FR-004**: 系统 MUST 精确实现“斗牛牛”的牌型计算和大小比较规则。
- **FR-005**: 系统 MUST 通过实时通信协议处理客户端的请求和推送游戏状态更新。
- **FR-006**: 所有游戏状态（如手牌、赌注、房间信息）都 MUST 在服务器内存中进行维护。
- **FR-007**: 系统 MUST 支持玩家在游戏中断后的一定时间内断线重连。

### Key Entities *(include if feature involves data)*

- **玩家 (Player)**: 代表一个游戏参与者。属性包括：用户ID、昵称、金币总额、当前手牌、下注额、游戏状态（是否庄家、是否准备等）。
- **房间 (Room)**: 代表一个游戏对局的环境。属性包括：房间ID、房间内的玩家列表、当前游戏阶段、庄家、底注大小、最小/最大下注额。
- **游戏 (Game)**: 代表一局具体游戏的实例。属性包括：参与本局的玩家、一副洗好的扑克牌、当前游戏状态机。

### Edge Cases

- 玩家在下注阶段金币不足时，系统应如何处理？
- 游戏服务器在对局中途重启，应如何恢复或处理正在进行的游戏？
- 多个玩家同时请求加入最后一个空位的房间时，系统如何保证一致性？

### Assumptions

- 存在一个能够与此服务器进行实时通信的客户端。
- 玩家身份验证和用户账户管理由外部服务负责。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 服务器能够稳定支持 100 个并发游戏房间，每个房间 5 名玩家。
- **SC-002**: 在满负载情况下，95% 的客户端请求响应时间低于 200 毫秒。
- **SC-003**: 单局游戏从开始到最终结算的完整流程，平均耗时不超过 3 分钟。
- **SC-004**: 服务器能够 7x24 小时无间断稳定运行，核心游戏逻辑不出错。