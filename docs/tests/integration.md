# 集成测试计划（HTTP + TCP）

更新时间：2025-10-11 22:22:24 +08:00

## 1. 范围
- HTTP（Gin）：用户注册/登录、鉴权访问、好友申请/接受、库存查询/增减、支付下单（mock）。
- TCP（Zinx）：加入房间、准备、发牌、抢庄、下注、摊牌、结算、断线重连、状态同步。

## 2. 环境
- 进程：Gin 服务 :8080；Zinx TCP :8999（`conf/zinx.json`）。
- 数据：PostgreSQL（测试库）、Redis（本地实例），测试前清理。

## 3. 前置
- 迁移执行（建表）；种子用户数据导入；配置 JWT 密钥；Redis 可用。

## 4. 测试用例（示例）

- 用户与鉴权
  - 注册成功/重复用户名
  - 登录成功/错误密码
  - 带 JWT 的 /users/me 成功；无 JWT/过期/伪造失败

- 好友与库存
  - 发送好友请求/接受/拒绝/黑名单
  - 查询库存；增减库存边界（负数/超限/非法 item）

- 支付
  - 下单成功（mock 渠道）、参数非法、金额越界
  - 回调处理与账本记录（模拟回调）

- 对局（TCP）
  - 正常流程：Join → Ready(all) → 发牌 → 抢庄（并列随机）→ 下注（全员）→ 摊牌 → 结算
  - 阶段超时：不提交抢庄/下注/摊牌时按默认策略推进
  - 断线重连：离线标记、重连后下发 `S2C_SyncRoomStateNtf` 快照
  - 错误路径：非阶段操作（如在 BETTING 发起抢庄）返回 `InvalidState`
  - 幂等：重复下注消息（相同 seq）不重复执行

## 5. 验收标准
- 所有用例通过；对局流程在 95% 以上运行中延迟 < 100ms/操作（本地）；广播不阻塞主流程。
- 监控指标可观测（QPS、错误率、阶段停留时长）。

## 6. 工具与脚本
- HTTP：`go test` + `net/http`/`resty`。
- TCP：自定义客户端（建议 `tests/e2e` 下实现），或引入小型驱动库。
- 数据准备脚本：`scripts/` 下提供迁移与清理脚本。
