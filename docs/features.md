# 功能模块详解

## 概述

本文档详细介绍斗牛游戏服务器的各个功能模块，包括房间管理、玩家管理、游戏流程、牌局逻辑等核心功能。

## 核心功能模块

### 1. 房间管理系统

#### 1.1 房间生命周期

**创建房间**:
- 支持动态创建房间
- 房间 ID 由客户端指定或服务端分配
- 每个房间最多容纳 5 名玩家

**房间状态**:
- 等待玩家：房间创建后的初始状态
- 游戏中：至少 2 名玩家准备后开始游戏
- 结算中：一局游戏结束后的结算阶段

**房间销毁**:
- 房间内无玩家时自动销毁
- 长时间无活动的房间自动清理（可配置）

#### 1.2 玩家加入/退出

**加入房间**:
```go
// 请求消息
C2S_JoinRoomReq {
    room_id: int32  // 房间ID
}

// 响应消息
S2C_JoinRoomAck {
    ret_code: int32      // 0表示成功
    room_info: RoomInfo  // 房间信息
}
```

**功能特性**:
- 自动创建不存在的房间
- 检查房间是否已满（5人上限）
- 防止重复加入同一房间
- 返回完整房间状态信息

**退出房间**:
- 玩家主动退出（发送离开房间请求）
- 连接断开自动退出
- 长时间离线（5分钟）强制踢出

#### 1.3 房间状态同步

**广播机制**:
- 玩家加入/离开时广播给房间内所有人
- 游戏状态变化时实时同步
- 玩家操作（抢庄、下注、摊牌）广播通知

**同步消息**:
```protobuf
S2C_SyncRoomStateNtf {
    room_info: RoomInfo
}

RoomInfo {
    room_id: int32
    players: []PlayerInfo
    game_state: GameState
    banker_id: int64
}
```

### 2. 玩家管理系统

#### 2.1 玩家属性

**基本信息**:
- 玩家 ID（唯一标识）
- 昵称
- 积分/金币

**游戏状态**:
- `WAITING`: 等待状态（刚加入房间）
- `READY`: 准备状态
- `PLAYING`: 游戏中
- `OFFLINE`: 离线状态

**游戏数据**:
- 手牌（5张）
- 下注金额
- 庄家标识
- 牌型结果

#### 2.2 连接管理

**在线状态**:
- 通过 Zinx Connection 对象维护连接
- 实时检测连接状态
- 心跳检测（可扩展）

**断线处理**:
```
连接断开
    ↓
触发 OnConnStop Hook
    ↓
标记玩家为离线状态
    ↓
保留玩家在房间中（5分钟）
    ↓
超时后移除玩家
```

#### 2.3 断线重连

**重连流程**:
1. 客户端重新发送 `C2S_JoinRoomReq`
2. 服务器检测到已存在的玩家对象
3. 重新关联连接对象
4. 发送完整房间状态同步
5. 广播玩家重连通知

**数据恢复**:
- 恢复手牌
- 恢复游戏进度
- 恢复下注状态
- 同步当前游戏阶段

### 3. 游戏流程控制

#### 3.1 状态机设计

**游戏状态枚举**:
```go
STATE_WAITING_FOR_PLAYERS  // 等待玩家
STATE_DEALING              // 发牌
STATE_BIDDING              // 抢庄
STATE_BETTING              // 下注
STATE_SHOWDOWN             // 摊牌
STATE_SETTLEMENT           // 结算
```

**状态转换规则**:
| 当前状态 | 触发条件 | 下一状态 |
|---------|---------|---------|
| WAITING_FOR_PLAYERS | 2+ 玩家准备 | DEALING |
| DEALING | 发牌完成 | BIDDING |
| BIDDING | 选出庄家 | BETTING |
| BETTING | 所有闲家下注完成 | SHOWDOWN |
| SHOWDOWN | 所有玩家摊牌 | SETTLEMENT |
| SETTLEMENT | 结算完成 | WAITING_FOR_PLAYERS |

**状态转换保护**:
- 非法状态转换将被拒绝
- 记录状态转换日志
- 错误处理和回滚机制

#### 3.2 游戏阶段详解

##### 等待玩家阶段（WAITING_FOR_PLAYERS）

**功能**:
- 接受新玩家加入
- 玩家可设置准备状态
- 至少 2 名玩家准备后可开始游戏

**玩家准备**:
```protobuf
C2S_PlayerReadyReq {
    is_ready: bool  // true=准备, false=取消准备
}
```

##### 发牌阶段（DEALING）

**流程**:
1. 重置并洗牌（52张标准扑克）
2. 给每位玩家发 5 张牌
3. 发送手牌给各个玩家
4. 自动转换到抢庄阶段

**消息通知**:
```protobuf
S2C_GameStartNtf {
    banker_id: int64  // 庄家ID（如果已确定）
}

S2C_DealCardsNtf {
    hand: []Card  // 玩家的手牌
}
```

**注意事项**:
- 手牌仅发送给对应玩家（私密性）
- 其他玩家只知道有牌但看不到内容

##### 抢庄阶段（BIDDING）

**功能**:
- 玩家竞争成为庄家
- 提交抢庄倍数（0 表示不抢）
- 选出倍数最高的玩家为庄家

**抢庄请求**:
```protobuf
C2S_BidBankerReq {
    multiple: int32  // 抢庄倍数，0=不抢
}

S2C_BidBankerAck {
    ret_code: int32   // 0=成功
    player_id: int64  // 成功抢到庄的玩家ID
}
```

**选庄规则**:
- 简化版：第一个抢庄的玩家成为庄家
- 标准版：倍数最高者为庄家，平局则随机选择（待实现）

**广播通知**:
```protobuf
S2C_BidBankerNtf {
    countdown: int32  // 抢庄倒计时
}
```

##### 下注阶段（BETTING）

**功能**:
- 闲家根据手牌决定下注金额
- 庄家不需要下注
- 所有闲家下注完成后进入摊牌

**下注请求**:
```protobuf
C2S_PlaceBetReq {
    multiple: int32  // 下注倍数
}

S2C_PlaceBetAck {
    ret_code: int32   // 0=成功
    multiple: int32   // 下注倍数
}
```

**下注限制**:
- 倍数范围：1-10（可配置）
- 检查玩家余额（待实现）
- 已下注玩家不能重复下注

**广播通知**:
```protobuf
S2C_BetNtf {
    banker_id: int64  // 庄家ID
    countdown: int32  // 下注倒计时
}
```

##### 摊牌阶段（SHOWDOWN）

**功能**:
- 所有玩家亮出手牌
- 服务器计算牌型
- 比较大小决定输赢

**摊牌请求**:
```protobuf
C2S_ShowdownReq {
    sorted_hand: []Card  // 客户端排序后的手牌
}

S2C_ShowdownAck {
    ret_code: int32  // 0=成功
}
```

**牌型计算**:
- 自动识别牌型（无牛、牛一~牛牛、特殊牌型）
- 计算牛值
- 确定最大单张牌

**广播通知**:
```protobuf
S2C_ShowdownNtf {
    countdown: int32  // 摊牌倒计时
}
```

##### 结算阶段（SETTLEMENT）

**功能**:
- 比较庄家与各闲家的牌型
- 计算输赢金额
- 更新玩家积分

**结算规则**:
- 闲家赢：庄家赔付 `下注倍数 × 牌型倍率`
- 庄家赢：庄家收取 `下注倍数 × 牌型倍率`
- 牌型倍率：
  - 无牛：1 倍
  - 牛一~牛六：1 倍
  - 牛七~牛九：2 倍
  - 牛牛：3 倍
  - 特殊牌型：5 倍以上

**结算通知**:
```protobuf
S2C_GameResultNtf {
    results: []PlayerResult
}

PlayerResult {
    player_id: int64
    hand: []Card
    card_pattern: CardPattern
    score_change: int64      // 分数变化（正数=赢，负数=输）
    final_score: int64       // 最终分数
}
```

**重置状态**:
- 清空所有玩家手牌
- 重置下注金额
- 取消庄家标识
- 转换回等待状态

### 4. 牌局逻辑系统

#### 4.1 牌堆管理（Deck）

**标准牌堆**:
- 52 张扑克牌（不含大小王）
- 4 种花色：黑桃、红心、梅花、方块
- 13 种点数：A, 2-10, J, Q, K

**操作接口**:
```go
NewDeck() *Deck               // 创建新牌堆
Reset()                       // 重置牌堆
Shuffle()                     // 洗牌
DealCard() (Card, error)      // 发一张牌
DealCards(num int) ([]Card, error)  // 发多张牌
GetCardCount() int            // 剩余牌数
```

**洗牌算法**:
- Fisher-Yates 洗牌算法
- 使用当前时间作为随机种子
- 保证随机性

#### 4.2 牌型识别（Bull Logic）

**牛牛规则**:
1. 从 5 张牌中选 3 张，点数之和为 10 的倍数
2. 剩余 2 张牌点数之和的个位数即为"牛值"
3. 如果找不到这样的 3 张牌，则为"无牛"

**牌型枚举**:
```go
CARD_TYPE_NO_BULL       // 无牛
CARD_TYPE_BULL_1        // 牛一
CARD_TYPE_BULL_2        // 牛二
...
CARD_TYPE_BULL_9        // 牛九
CARD_TYPE_BULL_BOMB     // 牛牛
CARD_TYPE_FIVE_SMALL    // 五小牛
CARD_TYPE_BOMB          // 炸弹（四张相同）
CARD_TYPE_GOLDEN_FLOWER // 金花（同花顺）
```

**特殊牌型判断**:

##### 五小牛
- 条件：5 张牌点数之和 ≤ 10
- 特点：最强牌型之一
- 概率：极低

##### 炸弹
- 条件：4 张牌点数相同
- 特点：强于普通牛牛
- 示例：4 个 8 + 1 个其他牌

##### 金花（同花顺）
- 条件：5 张牌花色相同且连续
- 特点：最强牌型
- 示例：黑桃 5-6-7-8-9

##### 同花/顺子
- 同花但非顺子：按牛牛处理
- 顺子但非同花：按牛牛处理

**牌型计算接口**:
```go
// 计算牌型和牛值
CalculateBull(cards []*Card) (CardType, uint32)

// 比较两手牌大小
CompareHands(hand1, hand2 []*Card) int  // 1=手牌1赢, -1=手牌2赢, 0=平局
```

#### 4.3 大小比较规则

**比较顺序**:
1. **牌型比较**：优先级高的牌型获胜
2. **牛值比较**：牌型相同时，牛值大的获胜
3. **最大单张比较**：牛值相同时，最大单张牌点数大的获胜
4. **花色比较**：最大单张相同时，花色大的获胜（黑桃 > 红心 > 梅花 > 方块）

**点数大小**:
- K > Q > J > 10 > 9 > ... > 2 > A
- J、Q、K 在计算时都算 10 点

**示例**:
```
玩家A：牛九（点数9）
玩家B：牛八（点数8）
结果：玩家A 获胜

玩家A：牛牛（最大单张K）
玩家B：牛牛（最大单张Q）
结果：玩家A 获胜
```

### 5. 通信协议系统

#### 5.1 消息格式

**Protocol Buffers**:
- 使用 Protobuf v3 语法
- 高效的二进制序列化
- 强类型定义

**消息结构**:
```
┌─────────────┬─────────────┬─────────────┐
│  MsgID (4B) │ DataLen (4B)│ Data (N B)  │
├─────────────┼─────────────┼─────────────┤
│   uint32    │   uint32    │   []byte    │
└─────────────┴─────────────┴─────────────┘
```

#### 5.2 消息ID定义

**客户端到服务端（C2S）**:
- 101: `C2S_JOIN_ROOM_REQ` - 加入房间
- 102: `C2S_PLAYER_READY_REQ` - 玩家准备
- 103: `C2S_BID_BANKER_REQ` - 抢庄
- 104: `C2S_PLACE_BET_REQ` - 下注
- 105: `C2S_SHOWDOWN_REQ` - 摊牌
- 106: `C2S_LEAVE_ROOM_REQ` - 离开房间

**服务端到客户端（S2C）**:
- 201: `S2C_JOIN_ROOM_ACK` - 加入房间响应
- 202: `S2C_SYNC_ROOM_STATE_NTF` - 房间状态同步
- 203: `S2C_GAME_START_NTF` - 游戏开始通知
- 204: `S2C_DEAL_CARDS_NTF` - 发牌通知
- 205: `S2C_BID_BANKER_NTF` - 抢庄通知
- 206: `S2C_BET_NTF` - 下注通知
- 207: `S2C_SHOWDOWN_NTF` - 摊牌通知
- 208: `S2C_GAME_RESULT_NTF` - 游戏结果通知
- 209: `S2C_PLAYER_LEAVE_NTF` - 玩家离开通知
- 210: `S2C_BID_BANKER_ACK` - 抢庄响应
- 211: `S2C_PLACE_BET_ACK` - 下注响应
- 212: `S2C_SHOWDOWN_ACK` - 摊牌响应

#### 5.3 消息处理流程

```
Client 发送消息
    ↓
Zinx 接收并解析
    ↓
根据 MsgID 路由到对应 Handler
    ↓
Handler 解析消息体
    ↓
调用业务逻辑处理
    ↓
构造响应消息
    ↓
发送回客户端 / 广播
```

### 6. 配置管理系统

#### 6.1 服务器配置

**配置文件**: `conf/zinx.json`

```json
{
  "Name": "ZinxServerApp",
  "Host": "0.0.0.0",
  "TCPPort": 8999,
  "MaxConn": 12000,
  "WorkerPoolSize": 10
}
```

**配置项说明**:
- `Name`: 服务器名称标识
- `Host`: 监听地址（0.0.0.0 表示所有网卡）
- `TCPPort`: 监听端口号
- `MaxConn`: 最大并发连接数
- `WorkerPoolSize`: 工作协程池大小

#### 6.2 游戏规则配置（可扩展）

**可配置参数**:
- 房间最大人数
- 准备超时时间
- 抢庄超时时间
- 下注超时时间
- 摊牌超时时间
- 断线保留时间
- 下注倍数范围
- 牌型倍率配置

### 7. 日志系统

#### 7.1 日志类型

**InfoLogger**:
- 记录正常业务流程
- 玩家加入/离开
- 游戏状态转换
- 关键操作日志

**ErrorLogger**:
- 记录错误和异常
- 非法请求
- 状态转换失败
- 系统异常

#### 7.2 日志格式

```
[时间] [日志级别] [内容]
2025/10/15 10:30:15 [INFO] Player 12345 joined room 1
2025/10/15 10:30:20 [ERROR] Failed to deal cards to player 12345: deck is empty
```

#### 7.3 日志内容

**关键信息**:
- 玩家 ID
- 房间 ID
- 操作类型
- 状态变化
- 错误描述

## 功能完整性分析

### 已实现功能 ✅

1. ✅ 房间创建与管理
2. ✅ 玩家加入/退出
3. ✅ 断线重连基础逻辑
4. ✅ 游戏状态机
5. ✅ 发牌系统
6. ✅ 抢庄功能
7. ✅ 下注功能
8. ✅ 摊牌功能
9. ✅ 牌型计算（完整）
10. ✅ 牌型比较逻辑
11. ✅ Protocol Buffers 协议定义
12. ✅ 消息路由系统
13. ✅ 基础日志系统

### 部分实现功能 ⚠️

1. ⚠️ 结算逻辑（框架已搭建，计算待完善）
2. ⚠️ 广播机制（部分广播消息未实现）
3. ⚠️ 玩家准备功能（Handler 未完整实现）
4. ⚠️ 离开房间功能（Handler 定义但未实现）

### 待实现功能 ❌

1. ❌ 玩家身份验证
2. ❌ 数据持久化
3. ❌ 完整的结算系统
4. ❌ 倒计时机制
5. ❌ 自动开始游戏
6. ❌ 房间匹配系统
7. ❌ 观战功能
8. ❌ 聊天系统
9. ❌ 战绩统计
10. ❌ 反作弊机制

## 扩展建议

### 近期优化

1. 完善结算逻辑和分数计算
2. 实现所有广播通知消息
3. 添加倒计时和自动流转机制
4. 完善玩家准备和离开房间功能
5. 添加输入验证和错误处理

### 中期扩展

1. 添加玩家认证系统
2. 实现数据持久化（Redis/MySQL）
3. 添加房间匹配和快速开始
4. 实现聊天和表情系统
5. 添加战绩和排行榜

### 长期规划

1. 分布式部署支持
2. 跨服房间功能
3. 观战和回放系统
4. AI 机器人玩家
5. 多游戏模式支持
